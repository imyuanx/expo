{"version":3,"file":"Portal.js","sourceRoot":"","sources":["../../src/modal/Portal.tsx"],"names":[],"mappings":"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","sourcesContent":["import {\n  createContext,\n  use,\n  useCallback,\n  useEffect,\n  useState,\n  type PropsWithChildren,\n} from 'react';\nimport { StyleSheet, type ViewProps } from 'react-native';\n\nimport {\n  NativeModalPortalContent,\n  NativeModalPortalContentWrapper,\n  NativeModalPortalHost,\n} from './native';\n\ninterface PortalHostConfig {\n  hostId: string;\n  size: { width: number; height: number };\n  contentSize?: { width: number; height: number };\n  shouldUseContentHeight?: boolean;\n  isRegistered?: boolean;\n}\ninterface PortalContextType {\n  getHost: (hostId: string) => PortalHostConfig | undefined;\n  addHost: (config: PortalHostConfig) => void;\n  updateHost: (hostId: string, config: Partial<Omit<PortalHostConfig, 'hostId'>>) => void;\n  removeHost: (hostId: string) => void;\n}\n\nexport const PortalContext = createContext<PortalContextType>({\n  addHost: () => {},\n  getHost: () => undefined,\n  removeHost: () => {},\n  updateHost: () => {},\n});\n\nexport const PortalContextProvider = (props: PropsWithChildren) => {\n  const [hostConfigs, setHostConfigs] = useState<Map<string, PortalHostConfig>>(() => new Map());\n\n  const addHost = useCallback((config: PortalHostConfig) => {\n    setHostConfigs((prev) => new Map(prev).set(config.hostId, config));\n  }, []);\n\n  const getHost = useCallback(\n    (hostId: string) => {\n      return hostConfigs.get(hostId);\n    },\n    [hostConfigs]\n  );\n\n  // TODO: ENG-16597: Optimize this to avoid unnecessary rerenders of the whole app\n  const updateHost = useCallback(\n    (hostId: string, config: Partial<Omit<PortalHostConfig, 'hostId'>>) => {\n      setHostConfigs((prev) => {\n        const updated = new Map(prev);\n        const existingConfig = updated.get(hostId);\n        if (existingConfig) {\n          updated.set(hostId, { ...existingConfig, ...config });\n        }\n        return updated;\n      });\n    },\n    []\n  );\n\n  const removeHost = useCallback((hostId: string) => {\n    setHostConfigs((prev) => {\n      const updated = new Map(prev);\n      updated.delete(hostId);\n      return updated;\n    });\n  }, []);\n\n  return (\n    <PortalContext.Provider\n      value={{\n        addHost,\n        getHost,\n        updateHost,\n        removeHost,\n      }}>\n      {props.children}\n    </PortalContext.Provider>\n  );\n};\n\nexport interface ModalPortalHostProps {\n  hostId: string;\n  // When set to true, the portal will use the content height instead of the full height.\n  useContentHeight?: boolean;\n  style?: ViewProps['style'];\n  onRegistered?: (event: { nativeEvent: { hostId: string } }) => void;\n  onLayout?: (event: { nativeEvent: { layout: { width: number; height: number } } }) => void;\n}\n\nexport const ModalPortalHost = (props: ModalPortalHostProps) => {\n  const { addHost, removeHost, updateHost, getHost } = use(PortalContext);\n\n  useEffect(() => {\n    addHost({\n      hostId: props.hostId,\n      size: { width: 0, height: 0 },\n      contentSize: { width: 0, height: 0 },\n      shouldUseContentHeight: props.useContentHeight,\n      isRegistered: false,\n    });\n    return () => {\n      removeHost(props.hostId);\n    };\n  }, [props.hostId]);\n\n  const hostConfig = getHost(props.hostId);\n\n  const style = StyleSheet.flatten([\n    props.style,\n    props.useContentHeight ? { height: hostConfig?.contentSize?.height } : {},\n  ]);\n  return (\n    <NativeModalPortalHost\n      style={style}\n      hostId={props.hostId}\n      onLayout={(e) => {\n        updateHost(props.hostId, {\n          size: e.nativeEvent.layout,\n        });\n        props.onLayout?.(e);\n      }}\n      onRegistered={({ nativeEvent }) => {\n        updateHost(props.hostId, {\n          isRegistered: true,\n        });\n        props.onRegistered?.({ nativeEvent });\n      }}\n      onUnregistered={() => {\n        updateHost(props.hostId, {\n          isRegistered: false,\n        });\n      }}\n    />\n  );\n};\n\nexport const PortalContentHeightContext = createContext<{\n  setHeight: (height: number | undefined) => void;\n}>({\n  setHeight: () => {},\n});\n\nexport interface ModalPortalContentProps {\n  hostId: string;\n  children: React.ReactNode;\n}\n\nexport const ModalPortalContent = (props: ModalPortalContentProps) => {\n  const { getHost, updateHost } = use(PortalContext);\n  const setContentHeight = useCallback(\n    (height: number | undefined) => {\n      updateHost(props.hostId, {\n        contentSize: { width: 0, height: height ?? 0 },\n      });\n    },\n    [props.hostId, updateHost]\n  );\n\n  const hostConfig = getHost(props.hostId);\n  // At first render, the hostId might not be registered yet\n  if (!hostConfig || !hostConfig.isRegistered) {\n    // Returning null here to avoid rendering the content\n    return null;\n  }\n\n  const hostSize = hostConfig?.size;\n  // If the host size is not available, we cannot render the content\n  // Otherwise layout glitches may occur\n  if (!hostSize || (!hostSize.width && !hostSize.height)) {\n    return null;\n  }\n\n  return (\n    <NativeModalPortalContentWrapper hostId={props.hostId}>\n      <NativeModalPortalContent\n        style={{\n          // Using position absolute, to \"extract\" the content from parent layout and position in host\n          position: 'absolute',\n          width: hostSize.width || undefined,\n          height: hostConfig.shouldUseContentHeight ? undefined : hostSize.height,\n        }}>\n        <PortalContentHeightContext value={{ setHeight: setContentHeight }}>\n          {props.children}\n        </PortalContentHeightContext>\n      </NativeModalPortalContent>\n    </NativeModalPortalContentWrapper>\n  );\n};\n"]}